<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Service Manager</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#9fb1d6;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --good:#30d158;
      --warn:#ffd60a;
      --bad:#ff453a;
      --accent:#5b8cff;

      --panel1: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.02);

      --selectBg: rgba(10,16,30,.92);
      --optionBg: #0f1930;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1000px 600px at 20% 0%, rgba(91,140,255,.25), transparent 60%),
                  radial-gradient(1000px 600px at 80% 10%, rgba(48,209,88,.18), transparent 55%),
                  var(--bg);
      min-height:100vh;
      overflow-x:hidden;
    }
    .container{max-width:1700px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      padding:16px;border:1px solid var(--border);border-radius:var(--radius);
      background: linear-gradient(180deg, var(--panel1), var(--panel2));
      box-shadow:var(--shadow);
    }
    .title{display:flex;flex-direction:column;gap:6px;min-width:320px}
    .title h1{font-size:18px;margin:0}
    .title p{margin:0;color:var(--muted);font-size:13px}

    .right{display:flex;flex-direction:column;gap:10px;align-items:flex-end;flex:1}
    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .nav .btn{padding:9px 12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end}

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer; user-select:none;
      transition:.15s transform, .15s background;
      font-weight:800; font-size:13px;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .btn.primary{background:rgba(91,140,255,.25);border-color:rgba(91,140,255,.45)}
    .btn.danger{background:rgba(255,69,58,.18);border-color:rgba(255,69,58,.35)}
    .btn.ok{background:rgba(48,209,88,.15);border-color:rgba(48,209,88,.35)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border); color:var(--muted); font-size:12px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .grid1{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    .gridSplit{display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;margin-top:14px}

    @media (max-width: 1100px){
      header{flex-direction:column;align-items:stretch}
      .right{align-items:flex-start}
      .row,.nav{justify-content:flex-start}
      .grid2,.gridSplit{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel1), var(--panel2));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:auto; /* ‚úÖ –ø–æ-—Å—Ç–µ–≥–Ω–∞—Ç–æ */
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-bottom:1px solid var(--border);
    }
    .cardHead h2{margin:0;font-size:14px}
    .cardBody{padding:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}

    .input, select, textarea{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      outline:none;
      min-width: 240px;
      max-width: 100%;
      font-size: 13px;
    }
    .input::placeholder, textarea::placeholder{color:rgba(231,238,252,.55)}

    /* ‚úÖ –ü–æ-—á–µ—Ç–∏–º–∏ –ø–∞–¥–∞—â–∏ –º–µ–Ω—é—Ç–∞ */
    select{
      background: var(--selectBg);
      color: var(--text);
    }
    option{
      background: var(--optionBg);
      color: var(--text);
    }

    .tableWrap{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      overflow:auto;
      max-height: 64vh;
      background: rgba(0,0,0,.10);
    }
    table{width:100%;border-collapse:collapse;min-width: 1180px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px;vertical-align:top}
    th{
      color:var(--muted);font-weight:900;font-size:12px;white-space:nowrap;
      position: sticky; top: 0;
      background: rgba(10,16,30,.92);
      backdrop-filter: blur(8px);
      z-index:2;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      font-size:12px;color:var(--text); background:rgba(255,255,255,.04)
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:#30d158}
    .dot.warn{background:#ffd60a}
    .dot.bad{background:#ff453a}

    .muted{color:var(--muted)}
    .empty{
      padding:18px;border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;color:var(--muted);text-align:center;background:rgba(255,255,255,.03)
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);font-size:12px;
    }

    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(17,27,46,.98), rgba(15,25,48,.98));
      border-radius:18px; box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .modalHead h3{margin:0;font-size:14px}
    .modalBody{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modalBody label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    .modalBody .full{grid-column:1 / -1}
    .modalFoot{padding:12px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(15,25,48,.95);border:1px solid var(--border);
      padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);
      display:none;font-size:13px;color:var(--text);
      z-index:60;
    }

    .twoCols{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 900px){ .twoCols{grid-template-columns:1fr} }
    .mini{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <h1>Service Manager</h1>
        <p>–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ (–±–∞–∑–∞) ‚Ä¢ –î–µ–º–æ ‚Ä¢ –°–µ—Ä–≤–∏–∑ ‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ ‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω–∏ ‚Ä¢ –ö–æ–Ω—Å—É–º–∞—Ç–∏–≤–∏ ‚Ä¢ –ù–∞–ª–∏—á–Ω–æ—Å—Ç —Ç–µ—Ö–Ω–∏–∫</p>
      </div>

      <div class="right">
        <div class="nav">
          <button class="btn primary" data-tab="demo">–î–µ–º–æ –º–∞—à–∏–Ω–∏</button>
          <button class="btn" data-tab="clients">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏</button>
          <button class="btn" data-tab="service">–°–µ—Ä–≤–∏–∑</button>
          <button class="btn" data-tab="pm">–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏</button>
          <button class="btn" data-tab="parts">–†–µ–∑–µ—Ä–≤–Ω–∏ —á–∞—Å—Ç–∏</button>
          <button class="btn" data-tab="cons">–ö–æ–Ω—Å—É–º–∞—Ç–∏–≤–∏</button>
          <button class="btn" data-tab="techinv">–ù–∞–ª–∏—á–Ω–æ—Å—Ç —Ç–µ—Ö–Ω–∏–∫</button>
          <button class="btn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div class="row">
          <span class="pill" id="statsPill">‚Äî</span>
          <span class="pill" id="whoPill">‚Äî</span>
          <button class="btn" id="btnExport">Export backup</button>
          <label class="btn" style="display:inline-flex;align-items:center;gap:8px;">
            Import backup
            <input id="fileImport" type="file" accept="application/json" style="display:none">
          </label>
          <button class="btn danger" id="btnReset">–ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–æ</button>
          <button class="btn" id="btnLogout">–ò–∑—Ö–æ–¥</button>
        </div>
      </div>
    </header>

    <!-- TAB: DEMO (–æ—Å—Ç–∞–≤—è–º –≥–æ –∫–∞–∫—Ç–æ –±–µ—à–µ) -->
    <section id="tab_demo" class="grid1">
      <section class="card">
        <div class="cardHead">
          <h2>–î–µ–º–æ –º–∞—à–∏–Ω–∏</h2>
          <div class="actions">
            <button class="btn primary" id="btnAddDemoMachine">+ –î–æ–±–∞–≤–∏ –¥–µ–º–æ –º–∞—à–∏–Ω–∞</button>
            <button class="btn ok" id="btnGiveDemo">+ –î–∞–π –ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qDemo" placeholder="–¢—ä—Ä—Å–∏ (–≤–∏–¥, —Å–µ—Ä.‚Ññ, –∞–ø–ª–∏–∫–∞—Ç–æ—Ä, —Å—Ç–∞—Ç—É—Å)..." />
            <span class="pill" id="demoCount">0</span>
          </div>
          <div id="demoEmpty" class="empty" style="display:none">–ù—è–º–∞ –¥–µ–º–æ –º–∞—à–∏–Ω–∏.</div>
          <div class="tableWrap">
            <table id="demoTable" style="min-width: 1400px">
              <thead>
                <tr>
                  <th>–í–∏–¥ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–ü—Ä–∏ –∫–ª–∏–µ–Ω—Ç</th>
                  <th style="width:280px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="toolbar" style="margin-top:12px">
            <input class="input" id="qDemoLoans" placeholder="–ò—Å—Ç–æ—Ä–∏—è (–∫–ª–∏–µ–Ω—Ç, —Å–µ—Ä.‚Ññ, –¥–∞—Ç–∞)..." />
            <span class="pill" id="demoLoansCount">0</span>
          </div>
          <div id="demoLoansEmpty" class="empty" style="display:none">–ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ –¥–µ–º–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è–Ω–∏—è.</div>
          <div class="tableWrap">
            <table id="demoLoansTable" style="min-width: 1500px">
              <thead>
                <tr>
                  <th>–î–∞–¥–µ–Ω–∞</th>
                  <th>–í—ä—Ä–Ω–∞—Ç–∞</th>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                  <th>–ê–¥—Ä–µ—Å</th>
                  <th>–í–∏–¥ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä</th>
                  <th>–ë–µ–ª–µ–∂–∫–∞</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px" class="badge">
            <span>‚úÖ</span>
            <span>–î–µ–º–æ –µ –æ—Ç–¥–µ–ª–Ω–æ –æ—Ç ‚Äú–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏‚Äù (–±–∞–∑–∞—Ç–∞).</span>
          </div>
        </div>
      </section>
    </section>

    <!-- TAB: INSTALLED BASE -->
    <section id="tab_clients" class="grid1" style="display:none">
      <section class="card">
        <div class="cardHead">
          <h2>–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏ (–ë–ê–ó–ê)</h2>
          <div class="actions">
            <button class="btn" id="btnAddClient">+ –î–æ–±–∞–≤–∏ –∫–ª–∏–µ–Ω—Ç</button>
            <button class="btn primary" id="btnAddInstalled">+ –î–æ–±–∞–≤–∏ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qInstalled" placeholder="–§–∏–ª—Ç—ä—Ä (–∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∞–¥—Ä–µ—Å, —Å–µ—Ä.‚Ññ, –≤–∏–¥)..." />
            <span class="pill" id="installedCount">0</span>
          </div>
          <div id="installedEmpty" class="empty" style="display:none">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏. –î–æ–±–∞–≤–∏ –∫–ª–∏–µ–Ω—Ç + –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞.</div>
          <div class="tableWrap">
            <table id="installedTable" style="min-width: 1550px">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                  <th>–ê–¥—Ä–µ—Å</th>
                  <th>–í–∏–¥ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th style="width:220px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="margin-top:10px" class="badge">
            <span>‚ÑπÔ∏è</span>
            <span>–°–µ—Ä–≤–∏–∑ / –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ / –ö–æ–Ω—Å—É–º–∞—Ç–∏–≤–∏ –∏–∑–ø–æ–ª–∑–≤–∞—Ç –∏–∑–±–æ—Ä –æ—Ç —Ç–∞–∑–∏ –±–∞–∑–∞.</span>
          </div>
        </div>
      </section>
    </section>

    <!-- TAB: SERVICE -->
    <section id="tab_service" class="grid1" style="display:none">
      <section class="card">
        <div class="cardHead">
          <h2>–°–µ—Ä–≤–∏–∑</h2>
          <div class="actions">
            <button class="btn primary" id="btnAddService">+ –ù–æ–≤ —Ä–µ–º–æ–Ω—Ç</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qService" placeholder="–¢—ä—Ä—Å–∏ (–∫–ª–∏–µ–Ω—Ç, —Å–µ—Ä.‚Ññ, –æ–ø–∏—Å–∞–Ω–∏–µ, —á–∞—Å—Ç–∏)..." />
            <span class="pill" id="serviceCount">0</span>
          </div>
          <div id="serviceEmpty" class="empty" style="display:none">–ù—è–º–∞ —Å–µ—Ä–≤–∏–∑–Ω–∏ –∑–∞–ø–∏—Å–∏.</div>
          <div class="tableWrap">
            <table id="serviceTable" style="min-width: 1600px">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                  <th>–ê–¥—Ä–µ—Å</th>
                  <th>–í–∏–¥ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ / —Ä–µ–º–æ–Ω—Ç</th>
                  <th>–í–ª–æ–∂–µ–Ω–∏ —á–∞—Å—Ç–∏</th>
                  <th>–¢–µ—Ö–Ω–∏–∫</th>
                  <th style="width:220px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px" class="badge">
            <span>‚öôÔ∏è</span>
            <span>–í–ª–æ–∂–µ–Ω–∏—Ç–µ —á–∞—Å—Ç–∏ —Å–µ –≤–∑–∏–º–∞—Ç –æ—Ç ‚Äú–ù–∞–ª–∏—á–Ω–æ—Å—Ç —Ç–µ—Ö–Ω–∏–∫‚Äù, –Ω–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç —Å–∫–ª–∞–¥–∞.</span>
          </div>
        </div>
      </section>
    </section>

    <!-- TAB: PM -->
    <section id="tab_pm" class="grid1" style="display:none">
      <section class="card">
        <div class="cardHead">
          <h2>–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ (–∑–∞ –≤—Å–∏—á–∫–∏ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏)</h2>
          <div class="actions">
            <button class="btn primary" id="btnMarkPM">+ –û—Ç–±–µ–ª–µ–∂–∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qPM" placeholder="–¢—ä—Ä—Å–∏ (–∫–ª–∏–µ–Ω—Ç, —Å–µ—Ä.‚Ññ, —Å—Ç–∞—Ç—É—Å)..." />
            <span class="pill" id="pmCount">0</span>
          </div>
          <div id="pmEmpty" class="empty" style="display:none">–ù—è–º–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏.</div>
          <div class="tableWrap">
            <table id="pmTable" style="min-width: 1500px">
              <thead>
                <tr>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                  <th>–ê–¥—Ä–µ—Å</th>
                  <th>–í–∏–¥ –º–∞—à–∏–Ω–∞</th>
                  <th>–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞</th>
                  <th>–ü–æ—Å–ª–µ–¥–Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞</th>
                  <th>–°–ª–µ–¥–≤–∞—â–∞ (1 –≥.)</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th style="width:280px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="margin-top:10px" class="badge">
            <span>‚è∞</span>
            <span>‚Äú–ß–∞–∫–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞‚Äù –∞–∫–æ –Ω—è–º–∞ –¥–∞—Ç–∞ –∏–ª–∏ –µ –º–∏–Ω–∞–ª–∞ —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞ –¥–∞—Ç–∞.</span>
          </div>
        </div>
      </section>
    </section>

    <!-- TAB: PARTS (‚úÖ –≤–µ—á–µ –µ –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–æ + –∑–∞—è–≤–∫–∏ –≥–æ—Ä–µ, —Å–∫–ª–∞–¥ –¥–æ–ª—É) -->
    <section id="tab_parts" class="grid1" style="display:none">

      <!-- –ó–∞—è–≤–∫–∏ –ì–û–†–ï -->
      <section class="card">
        <div class="cardHead">
          <h2>–ó–∞—è–≤–∫–∏ –∑–∞ —á–∞—Å—Ç–∏ (–∫—ä–º –∞–¥–º–∏–Ω)</h2>
          <div class="actions">
            <button class="btn ok" id="btnNewPartReq">+ –ù–æ–≤–∞ –∑–∞—è–≤–∫–∞</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qPartReq" placeholder="–¢—ä—Ä—Å–∏ (—á–∞—Å—Ç, —Å—Ç–∞—Ç—É—Å, —Ç–µ—Ö–Ω–∏–∫)..." />
            <span class="pill" id="partReqCount">0</span>
          </div>
          <div id="partReqEmpty" class="empty" style="display:none">–ù—è–º–∞ –∑–∞—è–≤–∫–∏.</div>
          <div class="tableWrap">
            <table id="partReqTable" style="min-width: 1400px">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ß–∞—Å—Ç</th>
                  <th>–ö–æ–ª.</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–¢–µ—Ö–Ω–∏–∫</th>
                  <th>–ë–µ–ª–µ–∂–∫–∞</th>
                  <th style="width:280px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="margin-top:10px" class="badge">
            <span>üîê</span>
            <span>–û–¥–æ–±—Ä–µ–Ω–∏–µ/–û—Ç–∫–∞–∑ —Å–µ –≤–∏–∂–¥–∞—Ç —Å–∞–º–æ –ø—Ä–∏ —Ä–æ–ª—è ‚Äú–ê–¥–º–∏–Ω‚Äù.</span>
          </div>
        </div>
      </section>

      <!-- –°–∫–ª–∞–¥ –î–û–õ–£ -->
      <section class="card">
        <div class="cardHead">
          <h2>–†–µ–∑–µ—Ä–≤–Ω–∏ —á–∞—Å—Ç–∏ (—Å–∫–ª–∞–¥)</h2>
          <div class="actions">
            <button class="btn primary" id="btnAddPart">+ –î–æ–±–∞–≤–∏ —á–∞—Å—Ç</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qParts" placeholder="–¢—ä—Ä—Å–∏ (–∞—Ä—Ç–∏–∫—É–ª ‚Ññ, –∏–º–µ)..." />
            <span class="pill" id="partsCount">0</span>
          </div>
          <div id="partsEmpty" class="empty" style="display:none">–ù—è–º–∞ —á–∞—Å—Ç–∏.</div>
          <div class="tableWrap">
            <table id="partsTable" style="min-width: 1100px">
              <thead>
                <tr>
                  <th>–ê—Ä—Ç–∏–∫—É–ª ‚Ññ</th>
                  <th>–ò–º–µ</th>
                  <th>–ù–∞–ª–∏—á–Ω–æ—Å—Ç (—Å–∫–ª–∞–¥)</th>
                  <th style="width:240px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="mini" style="margin-top:10px">
            –û–¥–æ–±—Ä–µ–Ω–∞ –∑–∞—è–≤–∫–∞ = –ø—Ä–µ—Ö–≤—ä—Ä–ª—è–Ω–µ –æ—Ç —Å–∫–ª–∞–¥ ‚Üí –∫—ä–º –Ω–∞–ª–∏—á–Ω–æ—Å—Ç –Ω–∞ —Ç–µ—Ö–Ω–∏–∫–∞.
          </div>
        </div>
      </section>

    </section>

    <!-- TAB: CONSUMABLES (‚úÖ –≤–µ—á–µ –µ –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–æ + –∏—Å—Ç–æ—Ä–∏—è –≥–æ—Ä–µ, —Å–∫–ª–∞–¥ –¥–æ–ª—É) -->
    <section id="tab_cons" class="grid1" style="display:none">

      <!-- –ò—Å—Ç–æ—Ä–∏—è –ì–û–†–ï -->
      <section class="card">
        <div class="cardHead">
          <h2>–ò–∑–ø–∏—Å–≤–∞–Ω–µ –∫—ä–º –∫–ª–∏–µ–Ω—Ç–∏ (–∏—Å—Ç–æ—Ä–∏—è)</h2>
          <div class="actions">
            <button class="btn ok" id="btnIssueCons">+ –ò–∑–ø–∏—à–∏ –∫—ä–º –∫–ª–∏–µ–Ω—Ç</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qConsHist" placeholder="–¢—ä—Ä—Å–∏ (–∫–ª–∏–µ–Ω—Ç, –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤)..." />
            <span class="pill" id="consHistCount">0</span>
          </div>
          <div id="consHistEmpty" class="empty" style="display:none">–ù—è–º–∞ –∏–∑–ø–∏—Å–≤–∞–Ω–∏—è.</div>
          <div class="tableWrap">
            <table id="consHistTable" style="min-width: 1250px">
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                  <th>–ê–¥—Ä–µ—Å</th>
                  <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                  <th>–ö–æ–ª.</th>
                  <th style="width:220px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="mini" style="margin-top:10px">–ü—Ä–∏ –∏–∑–ø–∏—Å–≤–∞–Ω–µ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç—Ç–∞ —Å–µ –Ω–∞–º–∞–ª—è–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</div>
        </div>
      </section>

      <!-- –°–∫–ª–∞–¥ –î–û–õ–£ -->
      <section class="card">
        <div class="cardHead">
          <h2>–ö–æ–Ω—Å—É–º–∞—Ç–∏–≤–∏ (—Å–∫–ª–∞–¥)</h2>
          <div class="actions">
            <button class="btn primary" id="btnAddCons">+ –î–æ–±–∞–≤–∏ –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qCons" placeholder="–¢—ä—Ä—Å–∏ (–∏–º–µ)..." />
            <span class="pill" id="consCount">0</span>
          </div>
          <div id="consEmpty" class="empty" style="display:none">–ù—è–º–∞ –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤–∏.</div>
          <div class="tableWrap">
            <table id="consTable" style="min-width: 900px">
              <thead>
                <tr>
                  <th>–ò–º–µ –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª</th>
                  <th>–ù–∞–ª–∏—á–Ω–æ—Å—Ç</th>
                  <th style="width:240px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="mini" style="margin-top:10px">–¢—É–∫ —É–ø—Ä–∞–≤–ª—è–≤–∞—à —Å–∫–ª–∞–¥–æ–≤–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç.</div>
        </div>
      </section>

    </section>

    <!-- TAB: TECH INVENTORY (‚úÖ –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–æ) -->
    <section id="tab_techinv" class="grid1" style="display:none">

      <!-- –ú–æ—è—Ç–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç –ì–û–†–ï -->
      <section class="card">
        <div class="cardHead">
          <h2>–ú–æ—è—Ç–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç (—Ç–µ—Ö–Ω–∏–∫)</h2>
          <div class="actions">
            <button class="btn ok" id="btnRequestFromStock">+ –ó–∞—è–≤–∏ –æ—Ç —Å–∫–ª–∞–¥</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qMyInv" placeholder="–¢—ä—Ä—Å–∏ (–∞—Ä—Ç–∏–∫—É–ª ‚Ññ, –∏–º–µ)..." />
            <span class="pill" id="myInvCount">0</span>
          </div>
          <div id="myInvEmpty" class="empty" style="display:none">–ù—è–º–∞—à –Ω–∞–ª–∏—á–Ω–æ—Å—Ç. –ü—É—Å–Ω–∏ –∑–∞—è–≤–∫–∞ –∫—ä–º –∞–¥–º–∏–Ω.</div>
          <div class="tableWrap">
            <table id="myInvTable" style="min-width: 1100px">
              <thead>
                <tr>
                  <th>–ê—Ä—Ç–∏–∫—É–ª ‚Ññ</th>
                  <th>–ò–º–µ</th>
                  <th>–ù–∞–ª–∏—á–Ω–æ—Å—Ç –ø—Ä–∏ –º–µ–Ω</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px" class="badge">
            <span>‚ÑπÔ∏è</span>
            <span>–ü—Ä–∏ —Ä–µ–º–æ–Ω—Ç –≤ ‚Äú–°–µ—Ä–≤–∏–∑‚Äù –≤–ª–æ–∂–µ–Ω–∏—Ç–µ —á–∞—Å—Ç–∏ —Å–µ –≤–∑–∏–º–∞—Ç –æ—Ç —Ç—É–∫.</span>
          </div>
        </div>
      </section>

      <!-- –ê–¥–º–∏–Ω –∏–∑–≥–ª–µ–¥ –î–û–õ–£ -->
      <section class="card">
        <div class="cardHead">
          <h2>–ù–∞–ª–∏—á–Ω–æ—Å—Ç –ø–æ —Ç–µ—Ö–Ω–∏—Ü–∏ (—Å–∞–º–æ –∞–¥–º–∏–Ω)</h2>
          <div class="actions">
            <select id="adminTechPick" style="min-width:220px"></select>
          </div>
        </div>
        <div class="cardBody">
          <div class="toolbar">
            <input class="input" id="qAdminInv" placeholder="–¢—ä—Ä—Å–∏ (–∞—Ä—Ç–∏–∫—É–ª ‚Ññ, –∏–º–µ)..." />
            <span class="pill" id="adminInvCount">0</span>
          </div>
          <div id="adminInvEmpty" class="empty" style="display:none">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</div>
          <div class="tableWrap">
            <table id="adminInvTable" style="min-width: 1100px">
              <thead>
                <tr>
                  <th>–ê—Ä—Ç–∏–∫—É–ª ‚Ññ</th>
                  <th>–ò–º–µ</th>
                  <th>–ù–∞–ª–∏—á–Ω–æ—Å—Ç –ø—Ä–∏ —Ç–µ—Ö–Ω–∏–∫–∞</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px" class="badge">
            <span>üîê</span>
            <span>–ê–∫–æ –Ω–µ —Å–∏ –∞–¥–º–∏–Ω, —Ç–∞–∑–∏ —Å–µ–∫—Ü–∏—è –µ –±–µ–∑ –¥–∞–Ω–Ω–∏.</span>
          </div>
        </div>
      </section>

    </section>

    <!-- TAB: SETTINGS -->
    <section id="tab_settings" class="grid1" style="display:none">
      <section class="card">
        <div class="cardHead"><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
        <div class="cardBody">
          <div class="twoCols">
            <div class="badge">
              <span>üë§</span>
              <span>–†–æ–ª—è:</span>
              <select id="roleSelect" style="min-width:160px">
                <option value="tech">–¢–µ—Ö–Ω–∏–∫</option>
                <option value="admin">–ê–¥–º–∏–Ω</option>
              </select>
            </div>

            <div class="badge">
              <span>üßë‚Äçüîß</span>
              <span>–¢–µ–∫—É—â —Ç–µ—Ö–Ω–∏–∫:</span>
              <select id="currentTechSelect" style="min-width:220px"></select>
            </div>
          </div>

          <div class="twoCols" style="margin-top:12px">
            <div class="badge" style="gap:10px;align-items:stretch">
              <div style="display:flex;flex-direction:column;gap:6px;">
                <span>‚ûï –î–æ–±–∞–≤–∏ —Ç–µ—Ö–Ω–∏–∫ (—Å–∞–º–æ –∞–¥–º–∏–Ω)</span>
                <input id="newTechName" class="input" placeholder="–ø—Ä–∏–º–µ—Ä: –ì–µ–æ—Ä–≥–∏" style="min-width:260px" />
              </div>
              <button class="btn ok" id="btnAddTech">–î–æ–±–∞–≤–∏</button>
            </div>

            <div class="badge">
              <span>üíæ</span>
              <span>–ó–∞—Å–µ–≥–∞ –¥–∞–Ω–Ω–∏—Ç–µ —Å–∞ –≤ –±—Ä–∞—É–∑—ä—Ä–∞. –ü–æ—Å–ª–µ: —Ä–µ–∞–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª–∏ + –±–∞–∑–∞ + –±–µ–∫—ä–ø–∏.</span>
            </div>
          </div>

        </div>
      </section>
    </section>

  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">–ó–∞–≥–ª–∞–≤–∏–µ</h3>
        <button class="btn" id="btnClose">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot">
        <button class="btn" id="btnCancel">–û—Ç–∫–∞–∑</button>
        <button class="btn primary" id="btnSave">–ó–∞–ø–∞–∑–∏</button>
      </div>
    </div>
  </div>

  
  <!-- Login Modal -->
  <div class="modalBack" id="loginBack">
    <div class="modal">
      <div class="modalHead">
        <h3>–í—Ö–æ–¥</h3>
        <span class="pill" id="loginHint">–í—ä–≤–µ–¥–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –∏ –ø–∞—Ä–æ–ª–∞</span>
      </div>
      <div class="modalBody">
        <label>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª
          <input class="input" id="loginUser" placeholder="admin" />
        </label>
        <label>–ü–∞—Ä–æ–ª–∞
          <input class="input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </label>
        <div class="mini" id="loginErr" style="color:rgba(255,69,58,.95);display:none">–ì—Ä–µ—à–Ω–∏ –¥–∞–Ω–Ω–∏.</div>
      </div>
      <div class="modalFoot">
        <button class="btn primary" id="btnDoLogin">–í—Ö–æ–¥</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------------- Tabs ----------------
    function setTab(tab){
      const ids = ["demo","clients","service","pm","parts","cons","techinv","settings"];
      for(const t of ids){
        const el = document.getElementById("tab_"+t);
        if(el) el.style.display = (t===tab) ? "" : "none";
      }
      document.querySelectorAll("button[data-tab]").forEach(b=>{
        b.classList.toggle("primary", b.dataset.tab === tab);
      });
    }
    document.addEventListener("click", (e)=>{
      const b = e.target.closest("button[data-tab]");
      if(!b) return;
      setTab(b.dataset.tab);
    });

    // ---------------- Storage ----------------
    const KEY = "service_manager_v3";

    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function addYears(dateISO, years){
      const d = new Date(dateISO + "T00:00:00");
      d.setFullYear(d.getFullYear() + years);
      return d.toISOString().slice(0,10);
    }
    function daysBetween(aISO, bISO){
      const a = new Date(aISO + "T00:00:00").getTime();
      const b = new Date(bISO + "T00:00:00").getTime();
      return Math.round((b - a) / (1000*60*60*24));
    }

    function seed(){
      const c1 = { id: uuid(), name:"–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤", phone:"0888 123 456", address:"–°–æ—Ñ–∏—è, —É–ª. –ü—Ä–∏–º–µ—Ä 1" };
      const c2 = { id: uuid(), name:"–ú–∞—Ä–∏—è –ì–µ–æ—Ä–≥–∏–µ–≤–∞", phone:"0899 111 222", address:"–ü–ª–æ–≤–¥–∏–≤, –±—É–ª. –¶–µ–Ω—Ç—ä—Ä 10" };

      const tech1 = { id: uuid(), name:"–¢–µ—Ö–Ω–∏–∫ 1" };
      const tech2 = { id: uuid(), name:"–¢–µ—Ö–Ω–∏–∫ 2" };

      const installed1 = { id: uuid(), date:"2026-01-15", clientId:c1.id, machineType:"–õ–∞–∑–µ—Ä X9", machineSerial:"LX9-888", applicatorSerial:"AP-9009", description:"–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞" };
      const installed2 = { id: uuid(), date:"2025-11-20", clientId:c2.id, machineType:"–õ–∞–∑–µ—Ä X7", machineSerial:"LX7-777", applicatorSerial:"AP-7070", description:"–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞" };

      const demo1 = { id: uuid(), type:"–î–µ–º–æ –õ–∞–∑–µ—Ä X1", machineSerial:"DLX1-001", applicatorSerial:"AP-1001", status:"–Ω–∞–ª–∏—á–Ω–∞" };
      const demo2 = { id: uuid(), type:"–î–µ–º–æ –õ–∞–∑–µ—Ä X2", machineSerial:"DLX2-014", applicatorSerial:"AP-2044", status:"–ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç" };

      const demoLoans = [
        { id: uuid(), demoId: demo2.id, clientId: c2.id, giveDate:"2026-02-05", returnDate:"", note:"–î–µ–º–æ –∑–∞ 7 –¥–Ω–∏" }
      ];

      const parts = [
        { id: uuid(), sku:"P-100", name:"–ü–ª–∞—Ç–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", qty: 3 },
        { id: uuid(), sku:"P-200", name:"–°–µ–Ω–∑–æ—Ä —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", qty: 8 },
      ];

      const consumables = [
        { id: uuid(), name:"–§–∏–ª—Ç—ä—Ä", qty: 15 },
        { id: uuid(), name:"–ú–∞—Ä–∫—É—á 1–º", qty: 40 },
      ];

      const techInventory = {};
      techInventory[tech1.id] = { [parts[1].id]: 2 };

      const service = [
        { id: uuid(), date:"2026-02-07", installedId: installed1.id, description:"–°–º—è–Ω–∞ –Ω–∞ —Å–µ–Ω–∑–æ—Ä.", techId: tech1.id, partsUsed:[{ partId: parts[1].id, qty: 1 }] }
      ];
      techInventory[tech1.id][parts[1].id] -= 1;

      const pmRecords = [
        { id: uuid(), installedId: installed1.id, lastDate:"2025-04-10" }
      ];

      const partRequests = [
        { id: uuid(), date:"2026-02-08", partId: parts[0].id, qty: 1, status:"—á–∞–∫–∞", techId: tech1.id, note:"–∑–∞ —Å–ª–µ–¥–≤–∞—â —Ä–µ–º–æ–Ω—Ç" }
      ];

      const consHistory = [
        { id: uuid(), date:"2026-02-08", installedId: installed2.id, itemId: consumables[0].id, qty: 2 }
      ];
      consumables[0].qty -= 2;

      return {
        role: "tech",
        techs: [tech1, tech2],
        currentTechId: tech1.id,

        clients: [c1, c2],
        installed: [installed1, installed2],

        demoMachines: [demo1, demo2],
        demoLoans,

        parts,
        partRequests,
        techInventory,

        consumables,
        consHistory,

        service,
        pmRecords
      };
    }

    function loadState(){
      const raw = localStorage.getItem(KEY);
      if(!raw) return seed();
      try{
        const s = JSON.parse(raw);

        s.role ??= "tech";
        s.techs ??= [];
        s.currentTechId ??= (s.techs[0]?.id || "");

        s.clients ??= [];
        s.installed ??= [];
        s.demoMachines ??= [];
        s.demoLoans ??= [];

        s.parts ??= [];
        s.partRequests ??= [];
        s.techInventory ??= {};

        s.consumables ??= [];
        s.consHistory ??= [];

        s.service ??= [];
        s.pmRecords ??= [];

        for(const t of s.techs){
          s.techInventory[t.id] ??= {};
        }

        return s;
      }catch{
        return seed();
      }
    }

    let state = loadState();
    
    // Try to bind current tech to server login (if server provides /me)
    async function applyLoginContext(){
      try{
        const res = await fetch("/me");
        if(!res.ok) return;
        const me = await res.json();
        if(!me || !me.logged_in) return false;

        // map role
        if(me.role === "admin") state.role = "admin";
        else state.role = "tech";

        // ensure a tech entry exists for technician users
        if(me.role !== "admin"){
          const name = me.display_name || me.username || "–¢–µ—Ö–Ω–∏–∫";
          // find tech by name or create
          let tech = state.techs.find(t => (t.name||"") === name);
          if(!tech){
            tech = { id: uuid(), name };
            state.techs.push(tech);
          }
          state.currentTechId = tech.id;
        }
        saveState();
      }catch(e){
        // ignore if server not available
      }
    }
function saveState(){
      localStorage.setItem(KEY, JSON.stringify(state));
      refresh();
      return true;
    }

    // ---------------- Helpers ----------------
    const $ = (id)=>document.getElementById(id);
    const norm = (s)=> (s||"").toString().trim().toLowerCase();

    // UUID helper (works even if crypto.randomUUID is missing)
    const uuid = ()=> {
      try{
        if(globalThis.crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
      }catch{}
      return "id-" + Date.now().toString(16) + "-" + Math.random().toString(16).slice(2);
    };

    function escapeHtml(s){
      return (s||"").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.style.display="none", 2200);
    }
    function statusTag(status){
      const s = norm(status);
      if(s.includes("–Ω–∞–ª")) return `<span class="tag"><span class="dot good"></span>–ù–∞–ª–∏—á–Ω–∞</span>`;
      if(s.includes("–∫–ª–∏")) return `<span class="tag"><span class="dot warn"></span>–ü—Ä–∏ –∫–ª–∏–µ–Ω—Ç</span>`;
      return `<span class="tag"><span class="dot warn"></span>${escapeHtml(status||"‚Äî")}</span>`;
    }
    function badge(cls, label){
      const dot = cls === "good" ? "good" : (cls === "warn" ? "warn" : "bad");
      return `<span class="tag"><span class="dot ${dot}"></span>${escapeHtml(label)}</span>`;
    }

    function getClient(id){ return state.clients.find(c=>c.id===id) || null; }
    function getInstalled(id){ return state.installed.find(x=>x.id===id) || null; }
    function getDemo(id){ return state.demoMachines.find(x=>x.id===id) || null; }
    function activeDemoLoan(demoId){ return state.demoLoans.find(l => l.demoId === demoId && !l.returnDate) || null; }

    function getPart(id){ return state.parts.find(p=>p.id===id) || null; }
    function getCons(id){ return state.consumables.find(x=>x.id===id) || null; }

    function getTech(id){ return state.techs.find(t=>t.id===id) || null; }
    function currentTech(){ return getTech(state.currentTechId) || null; }
    function invMap(techId){
      state.techInventory[techId] ??= {};
      return state.techInventory[techId];
    }
    function invQty(techId, partId){
      return Number(invMap(techId)[partId] || 0);
    }
    function addInv(techId, partId, qty){
      const m = invMap(techId);
      m[partId] = Number(m[partId] || 0) + qty;
      if(m[partId] <= 0) delete m[partId];
    }

    // ---------------- Modal ----------------
    function openModal(title, fields, onSave){
      $("modalTitle").textContent = title;
      const body = $("modalBody");
      body.innerHTML = fields.map(f=>{
        const full = f.full ? " full" : "";
        const val = f.value ?? "";
        if(f.type === "textarea"){
          return `
            <label class="${full}">
              ${escapeHtml(f.label)}
              <textarea class="input" id="f_${f.key}" rows="4" placeholder="${escapeHtml(f.placeholder||"")}" style="resize:vertical;min-height:90px">${escapeHtml(val)}</textarea>
            </label>
          `;
        }
        if(f.type === "select"){
          return `
            <label class="${full}">
              ${escapeHtml(f.label)}
              <select id="f_${f.key}">
                ${f.options.map(opt=>{
                  const sel = (opt.value === val) ? "selected" : "";
                  return `<option value="${escapeHtml(opt.value)}" ${sel}>${escapeHtml(opt.label)}</option>`;
                }).join("")}
              </select>
            </label>
          `;
        }
        return `
          <label class="${full}">
            ${escapeHtml(f.label)}
            <input class="input" id="f_${f.key}" placeholder="${escapeHtml(f.placeholder||"")}" value="${escapeHtml(val)}" />
          </label>
        `;
      }).join("");

      $("modalBack").style.display = "flex";
      $("btnSave").onclick = ()=>{
        const data = {};
        for(const f of fields){
          const el = document.getElementById("f_"+f.key);
          data[f.key] = (el?.value ?? "").trim();
        }
        onSave(data);
        closeModal();
      };
    }
    function closeModal(){
      $("modalBack").style.display = "none";
      $("modalBody").innerHTML = "";
    }
    $("btnClose").onclick = closeModal;
    $("btnCancel").onclick = closeModal;
    $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });

    // ---------------- Rendering ----------------
    function refresh(){
      const ct = currentTech();
      $("whoPill").textContent = ct ? `–¢–µ–∫—É—â: ${ct.name} ‚Ä¢ ${state.role==="admin" ? "–ê–¥–º–∏–Ω" : "–¢–µ—Ö–Ω–∏–∫"}` : `–¢–µ–∫—É—â: ‚Äî`;
      $("statsPill").textContent =
        `${state.installed.length} –∏–Ω—Å—Ç. ‚Ä¢ ${state.demoMachines.length} –¥–µ–º–æ ‚Ä¢ ${state.service.length} —Å–µ—Ä–≤–∏–∑ ‚Ä¢ ${state.parts.length} —á–∞—Å—Ç–∏ ‚Ä¢ ${state.consumables.length} –∫–æ–Ω—Å.`;

      $("roleSelect").value = state.role;
      renderTechSelects();

      renderInstalled();
      renderDemo();
      renderDemoLoans();
      renderService();
      renderPM();
      renderParts();
      renderPartRequests();
      renderCons();
      renderConsHistory();
      renderMyInv();
      renderAdminInv();
    }

    function renderTechSelects(){
      const opts = state.techs.map(t=>({ value:t.id, label:t.name }));
      const curSel = $("currentTechSelect");
      curSel.innerHTML = opts.map(o=>{
        const sel = o.value === state.currentTechId ? "selected" : "";
        return `<option value="${escapeHtml(o.value)}" ${sel}>${escapeHtml(o.label)}</option>`;
      }).join("");

      const adminPick = $("adminTechPick");
      if(adminPick){
        const canAdminSee = state.role === "admin";
        adminPick.disabled = !canAdminSee;
        adminPick.innerHTML = (canAdminSee ? opts : [{value:"",label:"‚Äî"}]).map(o=>{
          const sel = o.value === adminPick.value ? "selected" : "";
          return `<option value="${escapeHtml(o.value)}" ${sel}>${escapeHtml(o.label)}</option>`;
        }).join("");

        if(canAdminSee && !adminPick.value && state.techs[0]) adminPick.value = state.techs[0].id;
      }

      $("btnAddTech").disabled = (state.role !== "admin");
      $("newTechName").disabled = (state.role !== "admin");
    }

    // ---- Installed base ----
    function renderInstalled(){
      const q = norm($("qInstalled").value);
      const rows = state.installed
        .map(r=>({ r, c:getClient(r.clientId) }))
        .filter(x=>{
          const c = x.c || {};
          const blob =
            norm(x.r.date)+" "+norm(c.name)+" "+norm(c.phone)+" "+norm(c.address)+" "+
            norm(x.r.machineType)+" "+norm(x.r.machineSerial)+" "+norm(x.r.applicatorSerial)+" "+norm(x.r.description);
          return blob.includes(q);
        });

      $("installedCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("installedEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("installedTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({r,c})=>`
        <tr>
          <td>${escapeHtml(r.date||"")}</td>
          <td>${escapeHtml(c?.name||"‚Äî")}</td>
          <td>${escapeHtml(c?.phone||"")}</td>
          <td class="muted">${escapeHtml(c?.address||"")}</td>
          <td>${escapeHtml(r.machineType||"")}</td>
          <td>${escapeHtml(r.machineSerial||"")}</td>
          <td>${escapeHtml(r.applicatorSerial||"")}</td>
          <td class="muted">${escapeHtml(r.description||"")}</td>
          <td>
            <div class="actions">
              <button class="btn" data-act="editInstalled" data-id="${r.id}">–†–µ–¥–∞–∫—Ü–∏—è</button>
              <button class="btn danger" data-act="delInstalled" data-id="${r.id}">–ò–∑—Ç—Ä–∏–π</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    // ---- Demo ----
    function renderDemo(){
      const q = norm($("qDemo").value);
      const rows = state.demoMachines
        .map(m=>{
          const loan = activeDemoLoan(m.id);
          const client = loan ? getClient(loan.clientId) : null;
          return { m, loan, client };
        })
        .filter(x=>{
          const blob =
            norm(x.m.type)+" "+norm(x.m.machineSerial)+" "+norm(x.m.applicatorSerial)+" "+norm(x.m.status)+" "+
            norm(x.client?.name);
          return blob.includes(q);
        });

      $("demoCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("demoEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("demoTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({m,loan,client})=>{
        const atClient = loan ? `${client?.name||"‚Äî"} (${loan.giveDate})` : "‚Äî";
        const canReturn = norm(m.status) === "–ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç";
        return `
          <tr>
            <td>${escapeHtml(m.type)}</td>
            <td>${escapeHtml(m.machineSerial)}</td>
            <td>${escapeHtml(m.applicatorSerial||"")}</td>
            <td>${statusTag(m.status)}</td>
            <td class="muted">${escapeHtml(atClient)}</td>
            <td>
              <div class="actions">
                <button class="btn" data-act="editDemo" data-id="${m.id}">–†–µ–¥–∞–∫—Ü–∏—è</button>
                ${canReturn ? `<button class="btn ok" data-act="returnDemo" data-id="${m.id}">–í—ä—Ä–Ω–∞—Ç–∞</button>` : ``}
                <button class="btn danger" data-act="delDemo" data-id="${m.id}">–ò–∑—Ç—Ä–∏–π</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderDemoLoans(){
      const q = norm($("qDemoLoans").value);
      const rows = state.demoLoans
        .map(l=>{
          const c = getClient(l.clientId);
          const d = getDemo(l.demoId);
          return { l, c, d };
        })
        .filter(x=>{
          const blob =
            norm(x.l.giveDate)+" "+norm(x.l.returnDate)+" "+norm(x.c?.name)+" "+norm(x.c?.phone)+" "+norm(x.c?.address)+" "+
            norm(x.d?.machineSerial)+" "+norm(x.d?.type)+" "+norm(x.l.note);
          return blob.includes(q);
        });

      $("demoLoansCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("demoLoansEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("demoLoansTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({l,c,d})=>`
        <tr>
          <td>${escapeHtml(l.giveDate||"")}</td>
          <td>${escapeHtml(l.returnDate||"")}</td>
          <td>${escapeHtml(c?.name||"‚Äî")}</td>
          <td>${escapeHtml(c?.phone||"")}</td>
          <td class="muted">${escapeHtml(c?.address||"")}</td>
          <td>${escapeHtml(d?.type||"‚Äî")}</td>
          <td>${escapeHtml(d?.machineSerial||"")}</td>
          <td>${escapeHtml(d?.applicatorSerial||"")}</td>
          <td class="muted">${escapeHtml(l.note||"")}</td>
        </tr>
      `).join("");
    }

    // ---- PM ----
    function pmForInstalled(installedId){
      return state.pmRecords.find(p=>p.installedId===installedId) || null;
    }
    function pmStatus(lastDate){
      if(!lastDate) return { cls:"bad", label:"–ß–∞–∫–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞", next:"" };
      const next = addYears(lastDate, 1);
      const days = daysBetween(todayISO(), next);
      if(days < 0) return { cls:"bad", label:"–ß–∞–∫–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞", next };
      return { cls:"good", label:"–ò–∑–≤—ä—Ä—à–µ–Ω–∞", next };
    }
    function renderPM(){
      const q = norm($("qPM").value);
      const rows = state.installed
        .map(inst=>{
          const c = getClient(inst.clientId);
          const rec = pmForInstalled(inst.id);
          const st = pmStatus(rec?.lastDate || "");
          return { inst, c, rec, st };
        })
        .filter(x=>{
          const blob =
            norm(x.c?.name)+" "+norm(x.inst.machineSerial)+" "+norm(x.inst.machineType)+" "+norm(x.rec?.lastDate)+" "+norm(x.st.next)+" "+norm(x.st.label);
          return blob.includes(q);
        });

      $("pmCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("pmEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("pmTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({inst,c,rec,st})=>`
        <tr>
          <td>${escapeHtml(c?.name||"‚Äî")}</td>
          <td>${escapeHtml(c?.phone||"")}</td>
          <td class="muted">${escapeHtml(c?.address||"")}</td>
          <td>${escapeHtml(inst.machineType||"")}</td>
          <td>${escapeHtml(inst.machineSerial||"")}</td>
          <td>${escapeHtml(rec?.lastDate||"")}</td>
          <td>${escapeHtml(st.next||"")}</td>
          <td>${badge(st.cls, st.label)}</td>
          <td>
            <div class="actions">
              <button class="btn ok" data-act="pmDoneToday" data-id="${inst.id}">–ò–∑–≤—ä—Ä—à–µ–Ω–∞ (–¥–Ω–µ—Å)</button>
              <button class="btn" data-act="pmEdit" data-id="${inst.id}">–ó–∞–¥–∞–π –¥–∞—Ç–∞</button>
              ${rec ? `<button class="btn danger" data-act="pmClear" data-id="${inst.id}">–ò–∑—á–∏—Å—Ç–∏</button>` : ``}
            </div>
          </td>
        </tr>
      `).join("");
    }

    // ---- Parts ----
    function renderParts(){
      const q = norm($("qParts").value);
      const rows = state.parts.filter(p=>{
        const blob = norm(p.sku)+" "+norm(p.name)+" "+String(p.qty||0);
        return blob.includes(q);
      });
      $("partsCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("partsEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("partsTable").querySelector("tbody");
      tbody.innerHTML = rows.map(p=>`
        <tr>
          <td>${escapeHtml(p.sku||"")}</td>
          <td>${escapeHtml(p.name||"")}</td>
          <td>${escapeHtml(String(p.qty??0))}</td>
          <td>
            <div class="actions">
              <button class="btn" data-act="editPart" data-id="${p.id}">–†–µ–¥–∞–∫—Ü–∏—è</button>
              <button class="btn danger" data-act="delPart" data-id="${p.id}">–ò–∑—Ç—Ä–∏–π</button>
              <button class="btn" data-act="addStockPart" data-id="${p.id}">+ –ù–∞–ª–∏—á–Ω–æ—Å—Ç</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    function renderPartRequests(){
      const q = norm($("qPartReq").value);
      const rows = state.partRequests
        .map(r=>{
          const p = getPart(r.partId);
          const t = getTech(r.techId);
          return { r, p, t };
        })
        .filter(x=>{
          const blob =
            norm(x.r.date)+" "+norm(x.p?.name)+" "+norm(x.p?.sku)+" "+String(x.r.qty||0)+" "+norm(x.r.status)+" "+norm(x.t?.name)+" "+norm(x.r.note);
          return blob.includes(q);
        });

      $("partReqCount").textContent = `${rows.length} –∑–∞—è–≤–∫–∏`;
      $("partReqEmpty").style.display = rows.length ? "none" : "block";

      const isAdmin = state.role === "admin";
      const tbody = $("partReqTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({r,p,t})=>{
        const status = r.status === "—á–∞–∫–∞" ? badge("warn","–ß–∞–∫–∞") :
                       r.status === "–æ–¥–æ–±—Ä–µ–Ω–∞" ? badge("good","–û–¥–æ–±—Ä–µ–Ω–∞") :
                       badge("bad","–û—Ç–∫–∞–∑–∞–Ω–∞");
        return `
          <tr>
            <td>${escapeHtml(r.date||"")}</td>
            <td>${escapeHtml((p?.sku||"") + " " + (p?.name||""))}</td>
            <td>${escapeHtml(String(r.qty||0))}</td>
            <td>${status}</td>
            <td>${escapeHtml(t?.name||"‚Äî")}</td>
            <td class="muted">${escapeHtml(r.note||"")}</td>
            <td>
              <div class="actions">
                <button class="btn" data-act="delPartReq" data-id="${r.id}">–ò–∑—Ç—Ä–∏–π</button>
                ${isAdmin && r.status==="—á–∞–∫–∞" ? `<button class="btn ok" data-act="approveReq" data-id="${r.id}">–û–¥–æ–±—Ä–∏</button>` : ""}
                ${isAdmin && r.status==="—á–∞–∫–∞" ? `<button class="btn danger" data-act="denyReq" data-id="${r.id}">–û—Ç–∫–∞–∂–∏</button>` : ""}
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    // ---- Consumables ----
    function renderCons(){
      const q = norm($("qCons").value);
      const rows = state.consumables.filter(c=>{
        const blob = norm(c.name)+" "+String(c.qty||0);
        return blob.includes(q);
      });
      $("consCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("consEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("consTable").querySelector("tbody");
      tbody.innerHTML = rows.map(c=>`
        <tr>
          <td>${escapeHtml(c.name||"")}</td>
          <td>${escapeHtml(String(c.qty??0))}</td>
          <td>
            <div class="actions">
              <button class="btn" data-act="editCons" data-id="${c.id}">–†–µ–¥–∞–∫—Ü–∏—è</button>
              <button class="btn danger" data-act="delCons" data-id="${c.id}">–ò–∑—Ç—Ä–∏–π</button>
              <button class="btn" data-act="addStockCons" data-id="${c.id}">+ –ù–∞–ª–∏—á–Ω–æ—Å—Ç</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    function renderConsHistory(){
      const q = norm($("qConsHist").value);
      const rows = state.consHistory
        .map(h=>{
          const inst = getInstalled(h.installedId);
          const c = inst ? getClient(inst.clientId) : null;
          const item = getCons(h.itemId);
          return { h, c, item };
        })
        .filter(x=>{
          const blob =
            norm(x.h.date)+" "+norm(x.c?.name)+" "+norm(x.c?.phone)+" "+norm(x.c?.address)+" "+norm(x.item?.name)+" "+String(x.h.qty||0);
          return blob.includes(q);
        });

      $("consHistCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("consHistEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("consHistTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({h,c,item})=>`
        <tr>
          <td>${escapeHtml(h.date||"")}</td>
          <td>${escapeHtml(c?.name||"‚Äî")}</td>
          <td>${escapeHtml(c?.phone||"")}</td>
          <td class="muted">${escapeHtml(c?.address||"")}</td>
          <td>${escapeHtml(item?.name||"‚Äî")}</td>
          <td>${escapeHtml(String(h.qty||0))}</td>
          <td>
            <div class="actions">
              <button class="btn danger" data-act="delConsHist" data-id="${h.id}">–ò–∑—Ç—Ä–∏–π</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    // ---- Service ----
    function renderService(){
      const q = norm($("qService").value);
      const rows = state.service
        .map(s=>{
          const inst = getInstalled(s.installedId);
          const c = inst ? getClient(inst.clientId) : null;
          const t = getTech(s.techId);
          const partsText = (s.partsUsed||[]).map(u=>{
            const p = getPart(u.partId);
            return `${p?.sku||"?"} ${p?.name||"?"} x${u.qty}`;
          }).join("; ");
          return { s, inst, c, t, partsText };
        })
        .filter(x=>{
          const blob =
            norm(x.s.date)+" "+norm(x.c?.name)+" "+norm(x.inst?.machineSerial)+" "+norm(x.inst?.machineType)+" "+
            norm(x.s.description)+" "+norm(x.partsText)+" "+norm(x.t?.name);
          return blob.includes(q);
        });

      $("serviceCount").textContent = `${rows.length} –∑–∞–ø–∏—Å–∞`;
      $("serviceEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("serviceTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({s,inst,c,t,partsText})=>`
        <tr>
          <td>${escapeHtml(s.date||"")}</td>
          <td>${escapeHtml(c?.name||"‚Äî")}</td>
          <td>${escapeHtml(c?.phone||"")}</td>
          <td class="muted">${escapeHtml(c?.address||"")}</td>
          <td>${escapeHtml(inst?.machineType||"‚Äî")}</td>
          <td>${escapeHtml(inst?.machineSerial||"")}</td>
          <td>${escapeHtml(inst?.applicatorSerial||"")}</td>
          <td class="muted">${escapeHtml(s.description||"")}</td>
          <td class="muted">${escapeHtml(partsText||"")}</td>
          <td>${escapeHtml(t?.name||"‚Äî")}</td>
          <td>
            <div class="actions">
              <button class="btn" data-act="editService" data-id="${s.id}">–†–µ–¥–∞–∫—Ü–∏—è</button>
              <button class="btn danger" data-act="delService" data-id="${s.id}">–ò–∑—Ç—Ä–∏–π</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    // ---- Tech inventory ----
    function renderMyInv(){
      const tech = currentTech();
      const q = norm($("qMyInv").value);
      if(!tech){
        $("myInvCount").textContent = "0";
        $("myInvEmpty").style.display = "block";
        $("myInvTable").querySelector("tbody").innerHTML = "";
        return;
      }
      const m = invMap(tech.id);
      const rows = Object.entries(m).map(([partId, qty])=>{
        const p = getPart(partId);
        return { p, qty: Number(qty||0) };
      }).filter(x=>{
        const blob = norm(x.p?.sku)+" "+norm(x.p?.name)+" "+String(x.qty||0);
        return blob.includes(q);
      });

      $("myInvCount").textContent = `${rows.length}`;
      $("myInvEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("myInvTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({p,qty})=>`
        <tr>
          <td>${escapeHtml(p?.sku||"‚Äî")}</td>
          <td>${escapeHtml(p?.name||"‚Äî")}</td>
          <td>${escapeHtml(String(qty))}</td>
        </tr>
      `).join("");
    }

    function renderAdminInv(){
      const can = state.role === "admin";
      const q = norm($("qAdminInv").value);
      if(!can){
        $("adminInvCount").textContent = "0";
        $("adminInvEmpty").style.display = "block";
        $("adminInvTable").querySelector("tbody").innerHTML = "";
        return;
      }
      const techId = $("adminTechPick").value || state.techs[0]?.id || "";
      const m = techId ? invMap(techId) : {};
      const rows = Object.entries(m).map(([partId, qty])=>{
        const p = getPart(partId);
        return { p, qty: Number(qty||0) };
      }).filter(x=>{
        const blob = norm(x.p?.sku)+" "+norm(x.p?.name)+" "+String(x.qty||0);
        return blob.includes(q);
      });

      $("adminInvCount").textContent = `${rows.length}`;
      $("adminInvEmpty").style.display = rows.length ? "none" : "block";

      const tbody = $("adminInvTable").querySelector("tbody");
      tbody.innerHTML = rows.map(({p,qty})=>`
        <tr>
          <td>${escapeHtml(p?.sku||"‚Äî")}</td>
          <td>${escapeHtml(p?.name||"‚Äî")}</td>
          <td>${escapeHtml(String(qty))}</td>
        </tr>
      `).join("");
    }

    // ---------------- Filters ----------------
    $("qInstalled").addEventListener("input", renderInstalled);
    $("qDemo").addEventListener("input", renderDemo);
    $("qDemoLoans").addEventListener("input", renderDemoLoans);
    $("qService").addEventListener("input", renderService);
    $("qPM").addEventListener("input", renderPM);
    $("qParts").addEventListener("input", renderParts);
    $("qPartReq").addEventListener("input", renderPartRequests);
    $("qCons").addEventListener("input", renderCons);
    $("qConsHist").addEventListener("input", renderConsHistory);
    $("qMyInv").addEventListener("input", renderMyInv);
    $("qAdminInv").addEventListener("input", renderAdminInv);

    $("adminTechPick").addEventListener("change", renderAdminInv);

    // ---------------- Settings ----------------
    $("roleSelect").addEventListener("change", ()=>{
      state.role = $("roleSelect").value;
      saveState();
      toast("–†–æ–ª—è—Ç–∞ –µ —Å–º–µ–Ω–µ–Ω–∞.");
    });
    $("currentTechSelect").addEventListener("change", ()=>{
      state.currentTechId = $("currentTechSelect").value;
      saveState();
      toast("–°–º–µ–Ω–µ–Ω —Ç–µ–∫—É—â —Ç–µ—Ö–Ω–∏–∫.");
    });
    $("btnAddTech").onclick = ()=>{
      if(state.role !== "admin"){ toast("–°–∞–º–æ –∞–¥–º–∏–Ω –º–æ–∂–µ –¥–∞ –¥–æ–±–∞–≤—è —Ç–µ—Ö–Ω–∏—Ü–∏."); return; }
      const name = ($("newTechName").value||"").trim();
      if(!name){ toast("–í—ä–≤–µ–¥–∏ –∏–º–µ –Ω–∞ —Ç–µ—Ö–Ω–∏–∫."); return; }
      const t = { id: uuid(), name };
      state.techs.push(t);
      state.techInventory[t.id] = {};
      $("newTechName").value = "";
      saveState();
      toast("–î–æ–±–∞–≤–µ–Ω —Ç–µ—Ö–Ω–∏–∫.");
    };

    // ---------------- Add flows ----------------
    function addClientFlow(){
      openModal("–î–æ–±–∞–≤–∏ –∫–ª–∏–µ–Ω—Ç", [
        { key:"name", label:"–ö–ª–∏–µ–Ω—Ç", placeholder:"–∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç", full:true },
        { key:"phone", label:"–¢–µ–ª–µ—Ñ–æ–Ω", placeholder:"–ø—Ä–∏–º–µ—Ä: 0888 123 456" },
        { key:"address", label:"–ê–¥—Ä–µ—Å", placeholder:"–≥—Ä–∞–¥, —É–ª–∏—Ü–∞, ‚Ññ", full:true },
      ], (d)=>{
        if(!d.name){ toast("–ö–ª–∏–µ–Ω—Ç—ä—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω."); return; }
        state.clients.unshift({ id: uuid(), name:d.name, phone:d.phone, address:d.address });
        saveState();
        toast("–ö–ª–∏–µ–Ω—Ç—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω.");
      });
    }
    $("btnAddClient").onclick = addClientFlow;

    $("btnAddInstalled").onclick = ()=>{
      if(state.clients.length === 0){ toast("–ü—ä—Ä–≤–æ –¥–æ–±–∞–≤–∏ –∫–ª–∏–µ–Ω—Ç."); return; }
      const clientOptions = state.clients.map(c=>({ value:c.id, label:`${c.name}${c.phone ? " ‚Ä¢ "+c.phone : ""}` }));
      openModal("–î–æ–±–∞–≤–∏ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞ (–≤ –±–∞–∑–∞—Ç–∞)", [
        { key:"date", label:"–î–∞—Ç–∞ (YYYY-MM-DD)", value: todayISO() },
        { key:"clientId", label:"–ö–ª–∏–µ–Ω—Ç", type:"select", value: clientOptions[0].value, options: clientOptions, full:true },
        { key:"machineType", label:"–í–∏–¥ –º–∞—à–∏–Ω–∞", placeholder:"–ø—Ä–∏–º–µ—Ä: –õ–∞–∑–µ—Ä X9", full:true },
        { key:"machineSerial", label:"–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞", placeholder:"–ø—Ä–∏–º–µ—Ä: LX9-888" },
        { key:"applicatorSerial", label:"–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä", placeholder:"–ø—Ä–∏–º–µ—Ä: AP-9009" },
        { key:"description", label:"–û–ø–∏—Å–∞–Ω–∏–µ", type:"textarea", placeholder:"–æ–ø–∏—Å–∞–Ω–∏–µ/–±–µ–ª–µ–∂–∫–∞", full:true },
      ], (d)=>{
        if(!d.date || !d.clientId || !d.machineType || !d.machineSerial){
          toast("–î–∞—Ç–∞, –∫–ª–∏–µ–Ω—Ç, –≤–∏–¥ –º–∞—à–∏–Ω–∞ –∏ —Å–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞ —Å–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏.");
          return;
        }
        state.installed.unshift({
          id: uuid(),
          date: d.date,
          clientId: d.clientId,
          machineType: d.machineType,
          machineSerial: d.machineSerial,
          applicatorSerial: d.applicatorSerial,
          description: d.description
        });
        saveState();
        toast("–î–æ–±–∞–≤–µ–Ω–æ –≤ –±–∞–∑–∞—Ç–∞.");
      });
    };

    $("btnAddDemoMachine").onclick = ()=>{
      openModal("–î–æ–±–∞–≤–∏ –¥–µ–º–æ –º–∞—à–∏–Ω–∞", [
        { key:"type", label:"–í–∏–¥ –º–∞—à–∏–Ω–∞", placeholder:"–ø—Ä–∏–º–µ—Ä: –î–µ–º–æ –õ–∞–∑–µ—Ä X3", full:true },
        { key:"machineSerial", label:"–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞", placeholder:"–ø—Ä–∏–º–µ—Ä: DLX3-020" },
        { key:"applicatorSerial", label:"–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä", placeholder:"–ø—Ä–∏–º–µ—Ä: AP-3021" },
        { key:"status", label:"–°—Ç–∞—Ç—É—Å", type:"select", value:"–Ω–∞–ª–∏—á–Ω–∞", options:[
          {value:"–Ω–∞–ª–∏—á–Ω–∞", label:"–ù–∞–ª–∏—á–Ω–∞"},
          {value:"–ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç", label:"–ü—Ä–∏ –∫–ª–∏–µ–Ω—Ç"},
        ]},
      ], (d)=>{
        if(!d.type || !d.machineSerial){ toast("–í–∏–¥ –º–∞—à–∏–Ω–∞ –∏ –°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞ —Å–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏."); return; }
        state.demoMachines.unshift({
          id: uuid(),
          type: d.type,
          machineSerial: d.machineSerial,
          applicatorSerial: d.applicatorSerial,
          status: d.status || "–Ω–∞–ª–∏—á–Ω–∞"
        });
        saveState();
        toast("–î–µ–º–æ –º–∞—à–∏–Ω–∞—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞.");
      });
    };

    $("btnGiveDemo").onclick = ()=>{
      if(state.clients.length === 0){ toast("–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç–∏. –î–æ–±–∞–≤–∏ –∫–ª–∏–µ–Ω—Ç."); return; }
      const available = state.demoMachines.filter(m=>norm(m.status)==="–Ω–∞–ª–∏—á–Ω–∞");
      if(available.length === 0){ toast("–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –¥–µ–º–æ –º–∞—à–∏–Ω–∏."); return; }

      const demoOptions = available.map(m=>({ value:m.id, label:`${m.type} ‚Ä¢ ${m.machineSerial}${m.applicatorSerial ? " ‚Ä¢ "+m.applicatorSerial : ""}` }));
      const clientOptions = state.clients.map(c=>({ value:c.id, label:`${c.name}${c.phone ? " ‚Ä¢ "+c.phone : ""}` }));

      openModal("–î–∞–π –¥–µ–º–æ –º–∞—à–∏–Ω–∞ –ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç", [
        { key:"giveDate", label:"–î–∞—Ç–∞ (YYYY-MM-DD)", value: todayISO() },
        { key:"clientId", label:"–ö–ª–∏–µ–Ω—Ç", type:"select", value: clientOptions[0].value, options: clientOptions, full:true },
        { key:"demoId", label:"–ù–∞–ª–∏—á–Ω–∞ –¥–µ–º–æ –º–∞—à–∏–Ω–∞", type:"select", value: demoOptions[0].value, options: demoOptions, full:true },
        { key:"note", label:"–ë–µ–ª–µ–∂–∫–∞", type:"textarea", placeholder:"–ø—Ä–∏–º–µ—Ä: –¥–µ–º–æ –∑–∞ 7 –¥–Ω–∏", full:true },
      ], (d)=>{
        const client = getClient(d.clientId);
        const demo = getDemo(d.demoId);
        if(!client || !demo){ toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä."); return; }
        if(norm(demo.status)!=="–Ω–∞–ª–∏—á–Ω–∞"){ toast("–¢–∞–∑–∏ –¥–µ–º–æ –º–∞—à–∏–Ω–∞ –≤–µ—á–µ –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–∞."); return; }

        demo.status = "–ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç";
        state.demoLoans.unshift({
          id: uuid(),
          demoId: demo.id,
          clientId: client.id,
          giveDate: d.giveDate || todayISO(),
          returnDate: "",
          note: d.note
        });

        saveState();
        toast("–î–∞–¥–µ–Ω–æ. –°—Ç–∞—Ç—É—Å—ä—Ç –Ω–∞ –¥–µ–º–æ –º–∞—à–∏–Ω–∞—Ç–∞ –µ —Å–º–µ–Ω–µ–Ω.");
      });
    };

    $("btnMarkPM").onclick = ()=>{
      if(state.installed.length === 0){ toast("–ù—è–º–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏ (–±–∞–∑–∞)."); return; }
      const instOptions = state.installed.map(r=>{
        const c = getClient(r.clientId);
        return { value:r.id, label:`${c?.name||"‚Äî"} ‚Ä¢ ${r.machineSerial} ‚Ä¢ ${r.machineType}` };
      });
      openModal("–û—Ç–±–µ–ª–µ–∂–∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞", [
        { key:"installedId", label:"–ò–∑–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç/–º–∞—à–∏–Ω–∞ (–æ—Ç –±–∞–∑–∞—Ç–∞)", type:"select", value: instOptions[0].value, options: instOptions, full:true },
        { key:"lastDate", label:"–î–∞—Ç–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ (YYYY-MM-DD)", value: todayISO() },
      ], (d)=>{
        const inst = getInstalled(d.installedId);
        if(!inst || !d.lastDate){ toast("–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏."); return; }
        const existing = state.pmRecords.find(p=>p.installedId===inst.id);
        if(existing) existing.lastDate = d.lastDate;
        else state.pmRecords.unshift({ id: uuid(), installedId: inst.id, lastDate: d.lastDate });
        saveState();
        toast("–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞—Ç–∞ –µ –æ—Ç–±–µ–ª—è–∑–∞–Ω–∞.");
      });
    };

    // ---- REQUEST FROM STOCK ----
    $("btnRequestFromStock").onclick = ()=>{
      const tech = currentTech();
      if(!tech){ toast("–ò–∑–±–µ—Ä–∏ —Ç–µ–∫—É—â —Ç–µ—Ö–Ω–∏–∫ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏."); return; }
      if(state.parts.length === 0){ toast("–ù—è–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∏ —á–∞—Å—Ç–∏ –≤ —Å–∫–ª–∞–¥–∞."); return; }

      const partOptions = state.parts.map(p=>({ value:p.id, label:`${p.sku} ${p.name} (—Å–∫–ª–∞–¥: ${p.qty})` }));

      openModal("–ó–∞—è–≤–∫–∞ –∫—ä–º –∞–¥–º–∏–Ω (–≤–∑–µ–º–∞–Ω–µ –æ—Ç —Å–∫–ª–∞–¥)", [
        { key:"date", label:"–î–∞—Ç–∞ (YYYY-MM-DD)", value: todayISO() },
        { key:"partId", label:"–ß–∞—Å—Ç", type:"select", value: partOptions[0].value, options: partOptions, full:true },
        { key:"qty", label:"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", placeholder:"–ø—Ä–∏–º–µ—Ä: 1", value:"1" },
        { key:"note", label:"–ë–µ–ª–µ–∂–∫–∞", type:"textarea", placeholder:"–∑–∞ –∫–∞–∫–≤–æ –µ / –ø–æ –∂–µ–ª–∞–Ω–∏–µ", full:true },
      ], (d)=>{
        const qty = Number(d.qty||0);
        if(!d.partId || !isFinite(qty) || qty<=0){ toast("–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏."); return; }
        state.partRequests.unshift({
          id: uuid(),
          date: d.date || todayISO(),
          partId: d.partId,
          qty,
          status: "—á–∞–∫–∞",
          techId: tech.id,
          note: d.note
        });
        saveState();
        toast("–ó–∞—è–≤–∫–∞—Ç–∞ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞.");
      });
    };
    $("btnNewPartReq").onclick = ()=> $("btnRequestFromStock").onclick();

    // ---- SERVICE: deduct from technician inventory ----
    $("btnAddService").onclick = ()=>{
      const tech = currentTech();
      if(!tech){ toast("–ò–∑–±–µ—Ä–∏ —Ç–µ–∫—É—â —Ç–µ—Ö–Ω–∏–∫ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏."); return; }
      if(state.installed.length === 0){ toast("–ù—è–º–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏ (–±–∞–∑–∞)."); return; }

      const instOptions = state.installed.map(r=>{
        const c = getClient(r.clientId);
        return { value:r.id, label:`${c?.name||"‚Äî"} ‚Ä¢ ${r.machineSerial} ‚Ä¢ ${r.machineType}` };
      });

      const myMap = invMap(tech.id);
      const invPartIds = Object.keys(myMap);
      const invOptions = invPartIds.map(pid=>{
        const p = getPart(pid);
        return { value: pid, label: `${p?.sku||"?"} ${p?.name||"?"} (–ø—Ä–∏ –º–µ–Ω: ${invQty(tech.id, pid)})` };
      });

      openModal("–ù–æ–≤ —Ä–µ–º–æ–Ω—Ç", [
        { key:"date", label:"–î–∞—Ç–∞ (YYYY-MM-DD)", value: todayISO() },
        { key:"installedId", label:"–ò–∑–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç/–º–∞—à–∏–Ω–∞ (–æ—Ç –±–∞–∑–∞—Ç–∞)", type:"select", value: instOptions[0].value, options: instOptions, full:true },
        { key:"description", label:"–û–ø–∏—Å–∞–Ω–∏–µ / —Ä–µ–º–æ–Ω—Ç", type:"textarea", placeholder:"–∫–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ", full:true },

        { key:"part1", label:"–ß–∞—Å—Ç 1 (–æ—Ç –º–æ—è—Ç–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç)", type:"select", value:"", options:[{value:"",label:"‚Äî –Ω—è–º–∞ ‚Äî"}].concat(invOptions), full:true },
        { key:"qty1", label:"–ö–æ–ª. 1", placeholder:"–ø—Ä–∏–º–µ—Ä: 1", value:"" },

        { key:"part2", label:"–ß–∞—Å—Ç 2", type:"select", value:"", options:[{value:"",label:"‚Äî –Ω—è–º–∞ ‚Äî"}].concat(invOptions), full:true },
        { key:"qty2", label:"–ö–æ–ª. 2", placeholder:"–ø—Ä–∏–º–µ—Ä: 1", value:"" },

        { key:"part3", label:"–ß–∞—Å—Ç 3", type:"select", value:"", options:[{value:"",label:"‚Äî –Ω—è–º–∞ ‚Äî"}].concat(invOptions), full:true },
        { key:"qty3", label:"–ö–æ–ª. 3", placeholder:"–ø—Ä–∏–º–µ—Ä: 1", value:"" },
      ], (d)=>{
        const inst = getInstalled(d.installedId);
        if(!inst){ toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–∑–±–æ—Ä."); return; }
        if(!d.date){ toast("–î–∞—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞."); return; }

        const partsUsed = [];
        for(const n of [1,2,3]){
          const pid = d["part"+n];
          const q = Number(d["qty"+n] || 0);
          if(pid && q>0) partsUsed.push({ partId: pid, qty: q });
        }

        for(const u of partsUsed){
          const have = invQty(tech.id, u.partId);
          if(have < u.qty){
            const p = getPart(u.partId);
            toast(`–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç –ø—Ä–∏ —Ç–µ–±: ${p?.sku||"?"} ${p?.name||"?"}.`);
            return;
          }
        }
        for(const u of partsUsed){
          addInv(tech.id, u.partId, -u.qty);
        }

        state.service.unshift({
          id: uuid(),
          date: d.date,
          installedId: inst.id,
          description: d.description,
          techId: tech.id,
          partsUsed
        });

        saveState();
        toast(partsUsed.length ? "–†–µ–º–æ–Ω—Ç + –∏–∑–ø–∏—Å–∞–Ω–∏ —á–∞—Å—Ç–∏ –æ—Ç —Ç–≤–æ—è—Ç–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç." : "–†–µ–º–æ–Ω—Ç—ä—Ç –µ –∑–∞–ø–∏—Å–∞–Ω.");
      });
    };

    // ---- Add part/cons ----
    $("btnAddPart").onclick = ()=>{
      openModal("–î–æ–±–∞–≤–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∞ —á–∞—Å—Ç", [
        { key:"sku", label:"–ê—Ä—Ç–∏–∫—É–ª ‚Ññ", placeholder:"–ø—Ä–∏–º–µ—Ä: P-300" },
        { key:"name", label:"–ò–º–µ", placeholder:"–∏–º–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—Ç–∞ —á–∞—Å—Ç", full:true },
        { key:"qty", label:"–ù–∞–ª–∏—á–Ω–æ—Å—Ç (—Å–∫–ª–∞–¥)", placeholder:"–ø—Ä–∏–º–µ—Ä: 10" },
      ], (d)=>{
        if(!d.sku || !d.name){ toast("–ê—Ä—Ç–∏–∫—É–ª ‚Ññ –∏ –∏–º–µ —Å–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏."); return; }
        const qty = Number(d.qty||0);
        state.parts.unshift({ id: uuid(), sku:d.sku, name:d.name, qty: isFinite(qty)? qty : 0 });
        saveState();
        toast("–î–æ–±–∞–≤–µ–Ω–æ.");
      });
    };

    $("btnAddCons").onclick = ()=>{
      openModal("–î–æ–±–∞–≤–∏ –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤", [
        { key:"name", label:"–ò–º–µ –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª", placeholder:"–ø—Ä–∏–º–µ—Ä: –§–∏–ª—Ç—ä—Ä", full:true },
        { key:"qty", label:"–ù–∞–ª–∏—á–Ω–æ—Å—Ç", placeholder:"–ø—Ä–∏–º–µ—Ä: 20" },
      ], (d)=>{
        if(!d.name){ toast("–ò–º–µ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ."); return; }
        const qty = Number(d.qty||0);
        state.consumables.unshift({ id: uuid(), name:d.name, qty: isFinite(qty)? qty : 0 });
        saveState();
        toast("–î–æ–±–∞–≤–µ–Ω–æ.");
      });
    };

    $("btnIssueCons").onclick = ()=>{
      if(state.installed.length === 0){ toast("–ù—è–º–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∏ –º–∞—à–∏–Ω–∏ (–±–∞–∑–∞)."); return; }
      if(state.consumables.length === 0){ toast("–ù—è–º–∞ –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤–∏ (—Å–∫–ª–∞–¥)."); return; }

      const instOptions = state.installed.map(r=>{
        const c = getClient(r.clientId);
        return { value:r.id, label:`${c?.name||"‚Äî"} ‚Ä¢ ${r.machineSerial}` };
      });
      const consOptions = state.consumables.map(x=>({ value:x.id, label:`${x.name} (–Ω–∞–ª. ${x.qty})` }));

      openModal("–ò–∑–ø–∏—à–∏ –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤ –∫—ä–º –∫–ª–∏–µ–Ω—Ç", [
        { key:"date", label:"–î–∞—Ç–∞ (YYYY-MM-DD)", value: todayISO() },
        { key:"installedId", label:"–ö–ª–∏–µ–Ω—Ç/–º–∞—à–∏–Ω–∞ (–æ—Ç –±–∞–∑–∞—Ç–∞)", type:"select", value: instOptions[0].value, options: instOptions, full:true },
        { key:"itemId", label:"–ö–æ–Ω—Å—É–º–∞—Ç–∏–≤", type:"select", value: consOptions[0].value, options: consOptions, full:true },
        { key:"qty", label:"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", placeholder:"–ø—Ä–∏–º–µ—Ä: 1", value:"1" },
      ], (d)=>{
        const inst = getInstalled(d.installedId);
        const item = getCons(d.itemId);
        const qty = Number(d.qty||0);

        if(!inst || !item || !isFinite(qty) || qty<=0){ toast("–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏."); return; }
        if((item.qty||0) < qty){ toast("–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç."); return; }

        item.qty -= qty;
        state.consHistory.unshift({ id: uuid(), date: d.date || todayISO(), installedId: inst.id, itemId: item.id, qty });
        saveState();
        toast("–ò–∑–ø–∏—Å–∞–Ω–æ.");
      });
    };

    // ---------------- Actions ----------------
    document.addEventListener("click", (e)=>{
      const b = e.target.closest("button[data-act]");
      if(!b) return;
      const act = b.dataset.act;
      const id = b.dataset.id;

      if(act === "delInstalled"){
        if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è —Ç–æ–∑–∏ –∑–∞–ø–∏—Å –æ—Ç –±–∞–∑–∞—Ç–∞?")) return;
        state.installed = state.installed.filter(x=>x.id!==id);
        state.pmRecords = state.pmRecords.filter(p=>p.installedId!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
      if(act === "editInstalled"){
        const r = getInstalled(id);
        if(!r) return;
        const cOpts = state.clients.map(c=>({value:c.id, label:`${c.name}${c.phone ? " ‚Ä¢ "+c.phone : ""}`}));
        openModal("–†–µ–¥–∞–∫—Ü–∏—è: –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞ (–±–∞–∑–∞)", [
          { key:"date", label:"–î–∞—Ç–∞", value:r.date },
          { key:"clientId", label:"–ö–ª–∏–µ–Ω—Ç", type:"select", value:r.clientId, options:cOpts, full:true },
          { key:"machineType", label:"–í–∏–¥ –º–∞—à–∏–Ω–∞", value:r.machineType, full:true },
          { key:"machineSerial", label:"–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞", value:r.machineSerial },
          { key:"applicatorSerial", label:"–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä", value:r.applicatorSerial },
          { key:"description", label:"–û–ø–∏—Å–∞–Ω–∏–µ", type:"textarea", value:r.description, full:true },
        ], (d)=>{
          if(!d.date || !d.clientId || !d.machineType || !d.machineSerial){ toast("–õ–∏–ø—Å–≤–∞—Ç –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞."); return; }
          r.date=d.date; r.clientId=d.clientId; r.machineType=d.machineType; r.machineSerial=d.machineSerial;
          r.applicatorSerial=d.applicatorSerial; r.description=d.description;
          saveState(); toast("–ó–∞–ø–∞–∑–µ–Ω–æ.");
        });
      }

      if(act === "delDemo"){
        const m = getDemo(id);
        if(!m) return;
        if(!confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è –¥–µ–º–æ –º–∞—à–∏–Ω–∞: ${m.machineSerial}?`)) return;
        state.demoLoans = state.demoLoans.filter(l=>l.demoId!==id);
        state.demoMachines = state.demoMachines.filter(x=>x.id!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
      if(act === "editDemo"){
        const m = getDemo(id);
        if(!m) return;
        openModal("–†–µ–¥–∞–∫—Ü–∏—è: –¥–µ–º–æ –º–∞—à–∏–Ω–∞", [
          { key:"type", label:"–í–∏–¥ –º–∞—à–∏–Ω–∞", value:m.type, full:true },
          { key:"machineSerial", label:"–°–µ—Ä.‚Ññ –º–∞—à–∏–Ω–∞", value:m.machineSerial },
          { key:"applicatorSerial", label:"–°–µ—Ä.‚Ññ –∞–ø–ª–∏–∫–∞—Ç–æ—Ä", value:m.applicatorSerial },
          { key:"status", label:"–°—Ç–∞—Ç—É—Å", type:"select", value:m.status, options:[
            {value:"–Ω–∞–ª–∏—á–Ω–∞", label:"–ù–∞–ª–∏—á–Ω–∞"},
            {value:"–ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç", label:"–ü—Ä–∏ –∫–ª–∏–µ–Ω—Ç"},
          ]},
        ], (d)=>{
          if(!d.type || !d.machineSerial){ toast("–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞ –ª–∏–ø—Å–≤–∞—Ç."); return; }
          m.type=d.type; m.machineSerial=d.machineSerial; m.applicatorSerial=d.applicatorSerial; m.status=d.status;
          saveState(); toast("–ó–∞–ø–∞–∑–µ–Ω–æ.");
        });
      }
      if(act === "returnDemo"){
        const m = getDemo(id);
        if(!m) return;
        const loan = activeDemoLoan(m.id);
        if(!loan){ toast("–ù—è–º–∞ –∞–∫—Ç–∏–≤–µ–Ω –∑–∞–ø–∏—Å –∑–∞ —Ç–∞–∑–∏ –¥–µ–º–æ –º–∞—à–∏–Ω–∞."); return; }

        openModal("–í—Ä—ä—â–∞–Ω–µ –Ω–∞ –¥–µ–º–æ –º–∞—à–∏–Ω–∞", [
          { key:"returnDate", label:"–î–∞—Ç–∞ –Ω–∞ –≤—Ä—ä—â–∞–Ω–µ (YYYY-MM-DD)", value: todayISO() },
          { key:"note", label:"–ë–µ–ª–µ–∂–∫–∞ (–ø–æ –∏–∑–±–æ—Ä)", type:"textarea", value: loan.note || "", full:true },
        ], (d)=>{
          loan.returnDate = d.returnDate || todayISO();
          loan.note = d.note;
          m.status = "–Ω–∞–ª–∏—á–Ω–∞";
          saveState();
          toast("–í—ä—Ä–Ω–∞—Ç–∞. –°—Ç–∞—Ç—É—Å—ä—Ç –µ –ù–∞–ª–∏—á–Ω–∞.");
        });
      }

      if(act === "delService"){
        if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è —Å–µ—Ä–≤–∏–∑–Ω–∏—è –∑–∞–ø–∏—Å? (–Ω—è–º–∞ –≤—Ä—ä—â–∞–Ω–µ –Ω–∞ —á–∞—Å—Ç–∏)")) return;
        state.service = state.service.filter(x=>x.id!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
      if(act === "editService"){
        const s = state.service.find(x=>x.id===id);
        if(!s) return;
        openModal("–†–µ–¥–∞–∫—Ü–∏—è: —Å–µ—Ä–≤–∏–∑ (–±–µ–∑ –≤—Ä—ä—â–∞–Ω–µ –Ω–∞ —á–∞—Å—Ç–∏)", [
          { key:"date", label:"–î–∞—Ç–∞", value:s.date },
          { key:"description", label:"–û–ø–∏—Å–∞–Ω–∏–µ / —Ä–µ–º–æ–Ω—Ç", type:"textarea", value:s.description, full:true },
        ], (d)=>{
          if(!d.date){ toast("–î–∞—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞."); return; }
          s.date=d.date; s.description=d.description;
          saveState(); toast("–ó–∞–ø–∞–∑–µ–Ω–æ.");
        });
      }

      if(act === "pmDoneToday"){
        const existing = state.pmRecords.find(p=>p.installedId===id);
        if(existing) existing.lastDate = todayISO();
        else state.pmRecords.unshift({ id: uuid(), installedId: id, lastDate: todayISO() });
        saveState(); toast("–û—Ç–±–µ–ª—è–∑–∞–Ω–æ –∫–∞—Ç–æ –∏–∑–≤—ä—Ä—à–µ–Ω–∞ (–¥–Ω–µ—Å).");
      }
      if(act === "pmEdit"){
        const existing = state.pmRecords.find(p=>p.installedId===id);
        openModal("–ó–∞–¥–∞–π –¥–∞—Ç–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞", [
          { key:"lastDate", label:"–ü–æ—Å–ª–µ–¥–Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ (YYYY-MM-DD)", value: existing?.lastDate || todayISO() },
        ], (d)=>{
          if(!d.lastDate){ toast("–î–∞—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞."); return; }
          if(existing) existing.lastDate = d.lastDate;
          else state.pmRecords.unshift({ id: uuid(), installedId: id, lastDate: d.lastDate });
          saveState(); toast("–ó–∞–ø–∞–∑–µ–Ω–æ.");
        });
      }
      if(act === "pmClear"){
        if(!confirm("–î–∞ –∏–∑—á–∏—Å—Ç—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞—Ç–∞?")) return;
        state.pmRecords = state.pmRecords.filter(p=>p.installedId!==id);
        saveState(); toast("–ò–∑—á–∏—Å—Ç–µ–Ω–æ.");
      }

      if(act === "delPart"){
        const p = getPart(id);
        if(!p) return;
        if(!confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è —á–∞—Å—Ç: ${p.sku}?`)) return;
        state.parts = state.parts.filter(x=>x.id!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
      if(act === "editPart"){
        const p = getPart(id);
        if(!p) return;
        openModal("–†–µ–¥–∞–∫—Ü–∏—è: —Ä–µ–∑–µ—Ä–≤–Ω–∞ —á–∞—Å—Ç", [
          { key:"sku", label:"–ê—Ä—Ç–∏–∫—É–ª ‚Ññ", value:p.sku },
          { key:"name", label:"–ò–º–µ", value:p.name, full:true },
          { key:"qty", label:"–ù–∞–ª–∏—á–Ω–æ—Å—Ç (—Å–∫–ª–∞–¥)", value:String(p.qty??0) },
        ], (d)=>{
          if(!d.sku || !d.name){ toast("–ê—Ä—Ç–∏–∫—É–ª ‚Ññ –∏ –∏–º–µ —Å–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏."); return; }
          const q = Number(d.qty||0);
          p.sku=d.sku; p.name=d.name; p.qty = isFinite(q) ? q : p.qty;
          saveState(); toast("–ó–∞–ø–∞–∑–µ–Ω–æ.");
        });
      }
      if(act === "addStockPart"){
        const p = getPart(id);
        if(!p) return;
        openModal("–î–æ–±–∞–≤–∏ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç (—Å–∫–ª–∞–¥)", [
          { key:"add", label:`–ö–æ–ª–∫–æ –¥–∞ –¥–æ–±–∞–≤—è –∫—ä–º ${p.sku}?`, value:"1", full:true },
        ], (d)=>{
          const add = Number(d.add||0);
          if(!isFinite(add) || add<=0){ toast("–ù–µ–≤–∞–ª–∏–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ."); return; }
          p.qty += add;
          saveState(); toast("–î–æ–±–∞–≤–µ–Ω–æ.");
        });
      }

      if(act === "delPartReq"){
        if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –∑–∞—è–≤–∫–∞—Ç–∞?")) return;
        state.partRequests = state.partRequests.filter(x=>x.id!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
      if(act === "approveReq"){
        if(state.role !== "admin"){ toast("–°–∞–º–æ –∞–¥–º–∏–Ω –º–æ–∂–µ –¥–∞ –æ–¥–æ–±—Ä—è–≤–∞."); return; }
        const r = state.partRequests.find(x=>x.id===id);
        if(!r || r.status!=="—á–∞–∫–∞") return;
        const p = getPart(r.partId);
        if(!p){ toast("–õ–∏–ø—Å–≤–∞ —á–∞—Å—Ç."); return; }
        if((p.qty||0) < (r.qty||0)){ toast("–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç –≤ —Å–∫–ª–∞–¥–∞."); return; }

        p.qty -= r.qty;
        addInv(r.techId, r.partId, r.qty);
        r.status = "–æ–¥–æ–±—Ä–µ–Ω–∞";
        saveState();
        toast("–û–¥–æ–±—Ä–µ–Ω–æ: –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–æ –æ—Ç —Å–∫–ª–∞–¥ –∫—ä–º —Ç–µ—Ö–Ω–∏–∫–∞.");
      }
      if(act === "denyReq"){
        if(state.role !== "admin"){ toast("–°–∞–º–æ –∞–¥–º–∏–Ω –º–æ–∂–µ –¥–∞ –æ—Ç–∫–∞–∑–≤–∞."); return; }
        const r = state.partRequests.find(x=>x.id===id);
        if(!r || r.status!=="—á–∞–∫–∞") return;
        r.status = "–æ—Ç–∫–∞–∑–∞–Ω–∞";
        saveState(); toast("–û—Ç–∫–∞–∑–∞–Ω–æ.");
      }

      if(act === "delCons"){
        const c = getCons(id);
        if(!c) return;
        if(!confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤: ${c.name}?`)) return;
        state.consumables = state.consumables.filter(x=>x.id!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
      if(act === "editCons"){
        const c = getCons(id);
        if(!c) return;
        openModal("–†–µ–¥–∞–∫—Ü–∏—è: –∫–æ–Ω—Å—É–º–∞—Ç–∏–≤", [
          { key:"name", label:"–ò–º–µ", value:c.name, full:true },
          { key:"qty", label:"–ù–∞–ª–∏—á–Ω–æ—Å—Ç", value:String(c.qty??0) },
        ], (d)=>{
          if(!d.name){ toast("–ò–º–µ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ."); return; }
          const q = Number(d.qty||0);
          c.name=d.name; c.qty = isFinite(q) ? q : c.qty;
          saveState(); toast("–ó–∞–ø–∞–∑–µ–Ω–æ.");
        });
      }
      if(act === "addStockCons"){
        const c = getCons(id);
        if(!c) return;
        openModal("–î–æ–±–∞–≤–∏ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç (–∫–æ–Ω—Å—É–º–∞—Ç–∏–≤)", [
          { key:"add", label:`–ö–æ–ª–∫–æ –¥–∞ –¥–æ–±–∞–≤—è –∫—ä–º ${c.name}?`, value:"1", full:true },
        ], (d)=>{
          const add = Number(d.add||0);
          if(!isFinite(add) || add<=0){ toast("–ù–µ–≤–∞–ª–∏–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ."); return; }
          c.qty += add;
          saveState(); toast("–î–æ–±–∞–≤–µ–Ω–æ.");
        });
      }
      if(act === "delConsHist"){
        if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –∏–∑–ø–∏—Å–≤–∞–Ω–µ—Ç–æ? (–Ω—è–º–∞ –≤—Ä—ä—â–∞–Ω–µ)")) return;
        state.consHistory = state.consHistory.filter(x=>x.id!==id);
        saveState(); toast("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
    });

    // ---------------- Backup ----------------
    $("btnExport").onclick = ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Backup –µ –∏–∑—Ç–µ–≥–ª–µ–Ω.");
    };

    $("fileImport").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const data = JSON.parse(txt);
        if(!data || !Array.isArray(data.techs) || !Array.isArray(data.parts)){
          toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –±–µ–∫—ä–ø."); return;
        }
        state = data;

        state.role ??= "tech";
        state.techs ??= [];
        state.currentTechId ??= (state.techs[0]?.id || "");
        state.techInventory ??= {};
        for(const t of state.techs) state.techInventory[t.id] ??= {};

        state.clients ??= [];
        state.installed ??= [];
        state.demoMachines ??= [];
        state.demoLoans ??= [];
        state.partRequests ??= [];
        state.consumables ??= [];
        state.consHistory ??= [];
        state.service ??= [];
        state.pmRecords ??= [];

        saveState();
        toast("Backup –µ –∏–º–ø–æ—Ä—Ç–Ω–∞—Ç.");
      }catch{
        toast("–ù–µ —É—Å–ø—è—Ö –¥–∞ –ø—Ä–æ—á–µ—Ç–∞ —Ñ–∞–π–ª–∞.");
      }finally{
        e.target.value = "";
      }
    });

    $("btnReset").onclick = ()=>{
      if(!confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –¥–∞ –∏–∑—á–∏—Å—Ç—è –≤—Å–∏—á–∫–æ?")) return;
      localStorage.removeItem(KEY);
      state = seed();
      saveState();
      toast("–ò–∑—á–∏—Å—Ç–µ–Ω–æ.");
    };

    // ---------------- Filters (inputs exist in DOM) ----------------
    $("qInstalled").addEventListener("input", renderInstalled);
    $("qDemo").addEventListener("input", renderDemo);
    $("qDemoLoans").addEventListener("input", renderDemoLoans);
    $("qService").addEventListener("input", renderService);
    $("qPM").addEventListener("input", renderPM);
    $("qParts").addEventListener("input", renderParts);
    $("qPartReq").addEventListener("input", renderPartRequests);
    $("qCons").addEventListener("input", renderCons);
    $("qConsHist").addEventListener("input", renderConsHistory);
    $("qMyInv").addEventListener("input", renderMyInv);
    $("qAdminInv").addEventListener("input", renderAdminInv);

    
    // ---------------- Auth (login/logout) ----------------
    function showLogin(show){
      const back = document.getElementById("loginBack");
      if(!back) return;
      back.style.display = show ? "flex" : "none";
      if(show){
        const err = document.getElementById("loginErr");
        if(err) err.style.display = "none";
        const u = document.getElementById("loginUser");
        if(u) u.focus();
      }
    }

    async function doLogin(){
      const u = (document.getElementById("loginUser")?.value || "").trim();
      const p = (document.getElementById("loginPass")?.value || "").trim();
      try{
        const res = await fetch("/login", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({username:u, password:p})
        });
        if(!res.ok) throw new Error("bad");
        showLogin(false);
        await applyLoginContext();
        refresh();
        toast("–í–ª—è–∑—ä–ª/–≤–ª—è–∑–ª–∞.");
      }catch(e){
        const err = document.getElementById("loginErr");
        if(err) err.style.display = "block";
      }
    }

    document.getElementById("btnDoLogin")?.addEventListener("click", doLogin);
    document.getElementById("loginPass")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    document.getElementById("btnLogout")?.addEventListener("click", async ()=>{
      try{ await fetch("/logout", {method:"POST", headers:{"Content-Type":"application/json"}, body:"{}"}); }catch(e){}
      toast("–ò–∑—Ö–æ–¥.");
      // reload to clear UI context; will show login modal again
      location.reload();
    });

// ---------------- Start ----------------
    (async ()=>{ const ok = await applyLoginContext(); if(!ok){ showLogin(true); return; } refresh(); setTab("demo"); })();
  </script>
</body>
</html>