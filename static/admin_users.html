<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Админ – Потребители</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e7eefc}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:14px;background:rgba(255,255,255,.05);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:#e7eefc;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800}
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn.ok{background:rgba(48,209,88,.18);border-color:rgba(48,209,88,.35)}
    .btn.danger{background:rgba(255,69,58,.18);border-color:rgba(255,69,58,.35)}
    .input,select{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e7eefc;padding:10px 12px;border-radius:12px;min-width:220px}
    table{width:100%;border-collapse:collapse;margin-top:12px;min-width:860px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.12);text-align:left;vertical-align:top}
    th{color:#9fb1d6;font-size:12px;position:sticky;top:0;background:rgba(10,16,30,.92)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:#9fb1d6;font-size:12px;background:rgba(255,255,255,.04)}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(15,25,48,.95);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:12px;display:none}
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{width:min(520px,100%);border:1px solid rgba(255,255,255,.12);background:rgba(15,25,48,.98);border-radius:16px;overflow:hidden}
    .modalHead,.modalFoot{padding:12px;border-bottom:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modalFoot{border-top:1px solid rgba(255,255,255,.12);border-bottom:0;justify-content:flex-end}
    .modalBody{padding:12px;display:grid;gap:10px}
    label{display:grid;gap:6px;color:#9fb1d6;font-size:12px}
    .err{color:#ffb4ae;font-size:12px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:900;font-size:16px">Админ – Потребители</div>
          <div style="color:#9fb1d6;font-size:12px;margin-top:4px">Създаваш username + password + име (за техник)</div>
        </div>
        <div class="row">
          <span class="pill" id="mePill">—</span>
          <button class="btn" id="btnOpenApp">Отвори приложението</button>
          <button class="btn" id="btnLogout">Изход</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <input class="input" id="uUsername" placeholder="username (пример: tech2)"/>
        <input class="input" id="uPassword" placeholder="password"/>
        <select class="input" id="uRole">
          <option value="technician">Техник</option>
          <option value="admin">Админ</option>
        </select>
        <input class="input" id="uName" placeholder="Име на техник (само за техник)"/>
        <button class="btn ok" id="btnCreate">+ Създай</button>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <span class="pill" id="countPill">0</span>
        <button class="btn" id="btnReload">Обнови</button>
      </div>

      <div style="overflow:auto;max-height:70vh">
        <table>
          <thead>
            <tr><th>ID</th><th>Потребител</th><th>Роля</th><th>Име</th><th>Действия</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modalBack" id="loginBack">
    <div class="modal">
      <div class="modalHead">
        <div style="font-weight:900">Вход (само admin)</div>
        <span class="pill">admin/admin123</span>
      </div>
      <div class="modalBody">
        <label>Потребител <input class="input" id="loginUser" placeholder="admin"></label>
        <label>Парола <input class="input" id="loginPass" type="password" placeholder="••••••"></label>
        <div class="err" id="loginErr">Грешни данни.</div>
      </div>
      <div class="modalFoot">
        <button class="btn ok" id="btnLogin">Вход</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $=(id)=>document.getElementById(id);
    function toast(msg){const t=$("toast");t.textContent=msg;t.style.display="block";clearTimeout(toast._t);toast._t=setTimeout(()=>t.style.display="none",2200);}
    function esc(s){return (s||"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}
    async function api(path, opts){
      const res=await fetch(path, Object.assign({headers:{"Content-Type":"application/json"}}, opts||{}));
      const isJson=(res.headers.get("content-type")||"").includes("application/json");
      const data=isJson?await res.json().catch(()=>null):await res.text().catch(()=>null);
      if(!res.ok){
        const msg=(data && data.message) ? data.message : (typeof data==="string" ? data : "Грешка");
        const e=new Error(msg); e.status=res.status; throw e;
      }
      return data;
    }
    function showLogin(show){
      $("loginBack").style.display = show ? "flex" : "none";
      if(show){ $("loginErr").style.display="none"; $("loginUser").focus(); }
    }

    async function ensureMe(){
      try{
        const me=await api("/me");
        if(!me.logged_in){ showLogin(true); return; }
        const roleLabel = me.role==="admin" ? "Админ" : "Техник";
        $("mePill").textContent = `Профил: ${me.display_name || me.username} • ${roleLabel}`;
        if(me.role!=="admin"){ toast("Трябва да влезеш като admin."); }
        await loadUsers();
      }catch(e){
        toast("Няма връзка със сървъра.");
      }
    }

    async function doLogin(){
      try{
        const res=await api("/login",{method:"POST",body:JSON.stringify({username:$("loginUser").value.trim(),password:$("loginPass").value.trim()})});
        if(res.role!=="admin"){
          $("loginErr").style.display="block";
          $("loginErr").textContent="Трябва admin профил.";
          return;
        }
        showLogin(false);
        await ensureMe();
      }catch(e){
        $("loginErr").style.display="block";
        $("loginErr").textContent="Грешни данни.";
      }
    }

    $("btnLogin").onclick=doLogin;
    $("loginPass").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    $("btnLogout").onclick = async ()=>{
      try{ await api("/logout",{method:"POST",body:"{}"}); }catch{}
      toast("Изход."); showLogin(true);
      $("mePill").textContent="—"; $("tbody").innerHTML=""; $("countPill").textContent="0";
    };

    $("btnOpenApp").onclick = ()=> location.href="/";
    $("btnReload").onclick = ()=> loadUsers();

    async function loadUsers(){
      try{
        const rows=await api("/admin/users");
        $("countPill").textContent = `${rows.length} потребителя`;
        $("tbody").innerHTML = rows.map(u=>{
          const roleLabel = u.role==="admin" ? "Админ" : "Техник";
          return `<tr>
            <td>${u.id}</td>
            <td>${esc(u.username)}</td>
            <td>${esc(roleLabel)}</td>
            <td>${esc(u.display_name||"")}</td>
            <td>
              <button class="btn" data-act="pass" data-id="${u.id}">Смени парола</button>
              <button class="btn danger" data-act="del" data-id="${u.id}">Изтрий</button>
            </td>
          </tr>`;
        }).join("");
      }catch(e){
        if(e.status===401){ showLogin(true); return; }
        toast(e.message || "Грешка");
      }
    }

    $("btnCreate").onclick = async ()=>{
      const username=$("uUsername").value.trim();
      const password=$("uPassword").value.trim();
      const role=$("uRole").value;
      const display_name=$("uName").value.trim();
      try{
        await api("/admin/users",{method:"POST",body:JSON.stringify({username,password,role,display_name})});
        toast("Създадено.");
        $("uUsername").value=""; $("uPassword").value=""; $("uName").value="";
        await loadUsers();
      }catch(e){ toast(e.message || "Грешка"); }
    };

    document.addEventListener("click", async (e)=>{
      const b=e.target.closest("button[data-act]"); if(!b) return;
      const id=Number(b.dataset.id), act=b.dataset.act;
      if(act==="del"){
        if(!confirm("Да изтрия ли потребителя?")) return;
        try{ await api(`/admin/users/${id}`,{method:"DELETE"}); toast("Изтрито."); await loadUsers(); }
        catch(err){ toast(err.message || "Грешка"); }
      }
      if(act==="pass"){
        const pw=prompt("Нова парола:"); if(!pw) return;
        try{ await api(`/admin/users/${id}/password`,{method:"POST",body:JSON.stringify({password:pw})}); toast("Паролата е сменена."); }
        catch(err){ toast(err.message || "Грешка"); }
      }
    });

    ensureMe();
  </script>
</body>
</html>
